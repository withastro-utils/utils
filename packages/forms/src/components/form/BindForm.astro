---
import { asyncContext } from '@astro-utils/context';
import getContext from '@astro-utils/context';
import ViewStateManager from '../../components-control/form-utils/view-state.js';
import { BindContext } from '../../components-control/types.js';
import Bind, { type BindTypes } from '../../components-control/form-utils/bind-form.js';

export interface Props {
    bind?: ReturnType<typeof Bind>;
    state?: boolean | string[];
    omitState?: string[];
    defaultSubmitClick?: string | false;
    key?: string;
}

const { renderForm = true, bindId: parentBindId = '', settings: parentSettings = {}, reloadForm = false } = getContext(Astro, '@astro-utils/forms');
if (!renderForm) {
    return;
}

const { bind = Bind(), defaultSubmitClick, key = '' } = Astro.props;

const counter = ++Astro.locals.__formsInternalUtils.bindFormCounter;
const bindId = key || counter.toString();
const context: BindContext = (Astro.locals.__formsInternalUtils.bindGlobalState[bindId] ??= {
    executeAfter: [],
    method: 'GET',
    bind,
    tempBindValues: {},
    elementsState: {} as any,
    onSubmitClickGlobal: defaultSubmitClick as string,
    buttonIds: [] as [string, string | null, boolean][],
    settings: { showValidationErrors: false, reloadState: false },
    bindId,
    renderForm: false,
    newState: false,
    reloadForm: false,
});

if(reloadForm){
    context.reloadForm = true;
}

const resetContext = () => {
    context.buttonIds = [];
    context.tempBindValues = {};
    context.executeAfter = [];
};

if (context.viewState) {
    const originalBind = context.bind;
    const newBind: BindTypes<{}> = (context.bind = Object.assign(bind, originalBind.__getState()));
    newBind.errors = originalBind.errors;
    newBind._plugins = originalBind._plugins;
    context.viewState._bind = newBind;


    if(reloadForm){
        if (bind.on.reloadState) {
        await bind.on.reloadState?.();
    }
    } else if(bind.on.stateLoaded) {
        await bind.on.stateLoaded?.();
    }

} else {
    const viewState = new ViewStateManager(bind, context.elementsState, Astro, context.bindId);
    context.viewState = viewState;
    context.newState = !(await viewState.loadState());
    if (bind.on.stateLoaded) {
        await bind.on.stateLoaded?.();
    }

    if (context.newState) {
        await bind.on.newState?.();
    }
}

// For some reason the first render, in astro appending in the opposite direction, meaning it first return the html and than runs the logic?
resetContext();
await asyncContext(() => Astro.slots.render('default'), Astro, { name: '@astro-utils/forms', context, lock: 'bindForm' + parentBindId });

if (!reloadForm) {
    // Get information about the form
    context.method = context.newState ? 'GET' : Astro.request.method;

    resetContext();
    await asyncContext(() => Astro.slots.render('default'), Astro, { name: '@astro-utils/forms', context, lock: 'bindForm' + parentBindId });
    bind.__finishFormValidation();

    if (context.method == 'POST') {
        if (!context.newState && bind.on.pagePostBack) {
            await bind.on.pagePostBack?.();
        }

        for (const func of context.executeAfter) {
            await func();
        }

        context.method = 'GET';
        resetContext();
        await asyncContext(() => Astro.slots.render('default'), Astro, { name: '@astro-utils/forms', context, lock: 'bindForm' + parentBindId });
    }

    // Edit form render, add default submit button
    if (context.onSubmitClickGlobal == null && context.buttonIds.length > 0) {
        const [buttonFormId, HTMLButtonId] = context.buttonIds.findLast(([, , whenFormOk]) => whenFormOk) ?? context.buttonIds.at(-1)!;
        const state = (context.elementsState[buttonFormId] ??= {});

        state.id = HTMLButtonId ?? `_${buttonFormId}`;
        context.onSubmitClickGlobal = state.id;
    }
}

resetContext();
context.renderForm = true;
let htmlSlot = await asyncContext(() => Astro.slots.render('default'), Astro, { name: '@astro-utils/forms', context, lock: 'bindForm' + parentBindId });
if (!reloadForm && context.settings.reloadState) {
    parentSettings.reloadState = true;

    if (!parentBindId) {
        Astro.locals.__formsInternalUtils.bindFormCounter = counter;
        context.reloadForm = true;
        htmlSlot = await asyncContext(() => Astro.slots.render('default'), Astro, { name: '@astro-utils/forms', context, lock: 'bindForm' + parentBindId });
    }
}
context.renderForm = false;
---

<input type='hidden' name={context.viewState.filedName} value={await context.viewState.createViewState()} />
<Fragment set:html={htmlSlot} />
